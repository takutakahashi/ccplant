# チャットインターフェース

## 概要

チャットインターフェースは、AI エージェント (Claude Code) とリアルタイムで対話するための主要な UI です。直感的なチャット形式で指示を送り、AI からのレスポンスをストリーミングで受信できます。

## 基本機能

### メッセージの送信

#### テキストメッセージ

1. チャット画面下部の入力エリアにメッセージを入力
2. Enter キーまたは送信ボタンをクリック
3. メッセージが送信され、AI が応答を開始

**入力エリアの特徴:**
- **複数行対応**: Shift+Enter で改行
- **自動リサイズ**: 入力内容に応じて高さが自動調整
- **プレースホルダー**: 「メッセージを入力...」と表示

**スクリーンショットの説明:**
入力エリアは画面下部に固定され、グレーの枠線で囲まれています。右側に青い送信ボタン (紙飛行機アイコン) が配置されています。

#### キーボードショートカット

効率的な操作のため、以下のショートカットが利用できます:

| ショートカット | 動作 | 説明 |
|--------------|------|------|
| **Cmd+Enter** (Mac) | メッセージ送信 | 入力中のメッセージを送信 |
| **Ctrl+Enter** (Windows/Linux) | メッセージ送信 | 入力中のメッセージを送信 |
| **Shift+Enter** | 改行 | 送信せずに改行 |
| **Esc** | 入力クリア | 入力内容をクリア |
| **↑** (矢印キー) | 前のメッセージ | 最後に送信したメッセージを再編集 |

**設定:**
キーボードショートカットは設定画面でカスタマイズできます。
→ [設定管理](./settings.md#キーボードショートカット)

#### メッセージの編集

送信済みのメッセージは編集できません。代わりに:
1. メッセージをコピー
2. 新しいメッセージとして修正版を送信
3. 「前のメッセージを無視して、以下の指示に従ってください」と明示

### ストリーミングレスポンス

AI からの応答はリアルタイムでストリーミング表示されます。

#### ストリーミングの動作

1. メッセージ送信後、AI が応答を開始
2. 応答テキストが1文字ずつ表示される
3. コードブロックや箇条書きもリアルタイムで整形される
4. 応答完了後、「完了」マークが表示される

**視覚的なフィードバック:**
- **入力中**: カーソルアニメーション (点滅する縦線)
- **処理中**: 思考中アイコン (3つの点が跳ねるアニメーション)
- **完了**: チェックマークアイコン

**スクリーンショットの説明:**
AI メッセージの右下に、小さなアニメーション (3つの点が順番に上下する) が表示され、応答中であることを示します。

#### ストリーミングの制御

- **停止**: 「停止」ボタンをクリックしてストリーミングを中断
- **再開**: 停止後、「続きを生成」ボタンで再開可能

```typescript
// ストリーミング停止の例
<button onClick={handleStopStreaming}>
  停止
</button>

// 停止後の続き生成
<button onClick={handleContinue}>
  続きを生成
</button>
```

### メッセージ履歴

チャット画面には、セッション内のすべてのメッセージ履歴が表示されます。

#### 履歴の表示

**ユーザーメッセージ:**
- 右寄せ
- 青色の背景
- 白色のテキスト
- 送信時刻の表示

**AI メッセージ:**
- 左寄せ
- グレーの背景
- 黒色のテキスト (Markdown フォーマット付き)
- 応答時刻の表示

**システムメッセージ:**
- 中央揃え
- 黄色の背景
- 小さめのフォント
- セッション開始やエラーなどの通知

#### スクロール動作

- **自動スクロール**: 新しいメッセージが届くと、自動的に最下部にスクロール
- **手動スクロール**: ユーザーが上にスクロールすると、自動スクロールが一時停止
- **最下部へ**: 右下の「↓」ボタンをクリックで最新メッセージへジャンプ

**スクリーンショットの説明:**
チャット画面の右下に、半透明の青い円形ボタン (下矢印アイコン) が浮いています。これをクリックすると、最新メッセージまでスクロールします。

#### 履歴の検索

チャット履歴内を検索できます:

1. 画面右上の検索アイコンをクリック
2. 検索ワードを入力
3. 該当するメッセージがハイライト表示
4. ↑↓ ボタンで該当メッセージ間を移動

**スクリーンショットの説明:**
検索バーは画面上部にスライドインし、検索ボックスと「前へ」「次へ」ボタンが表示されます。

### コードブロックの表示

AI が生成したコードは、シンタックスハイライト付きで表示されます。

#### 対応言語

- Python
- JavaScript / TypeScript
- Go
- Rust
- Java
- C / C++
- Shell / Bash
- YAML / JSON
- Markdown
- その他 (100+ 言語)

#### コードブロックの機能

**ヘッダー:**
```
┌──────────────────────────────────────┐
│ Python           [コピー] [実行]      │
├──────────────────────────────────────┤
│ def hello():                         │
│     print("Hello, World!")           │
└──────────────────────────────────────┘
```

**機能ボタン:**
1. **コピー**: コードをクリップボードにコピー
2. **実行** (オプション): 直接実行 (対応言語のみ)
3. **ダウンロード**: ファイルとしてダウンロード

**シンタックスハイライト:**
- キーワード: 青色
- 文字列: 緑色
- コメント: グレー
- 関数名: 紫色

**行番号:**
左側に行番号が表示されます (設定で無効化可能)。

**スクリーンショットの説明:**
コードブロックは、ダークグレーの背景に白いテキストで表示されます。上部に言語名とアクションボタン、左側に行番号が配置されています。

#### 長いコードの処理

コードが20行を超える場合:
1. 最初の20行のみ表示
2. 「すべて表示」ボタンで全体を展開
3. 「折りたたむ」ボタンで元に戻す

```typescript
// 折りたたみ制御
{isExpanded ? (
  <>
    {fullCode}
    <button onClick={handleCollapse}>折りたたむ</button>
  </>
) : (
  <>
    {truncatedCode}
    <button onClick={handleExpand}>すべて表示 ({totalLines} 行)</button>
  </>
)}
```

### URL の自動検出とリンク化

メッセージ内の URL は自動的にリンクとして認識され、クリック可能になります。

#### 対応 URL パターン

- **HTTP/HTTPS**: `https://example.com`
- **GitHub**: `https://github.com/user/repo`
- **GitHub Issue**: `https://github.com/user/repo/issues/123`
- **GitHub PR**: `https://github.com/user/repo/pull/456`
- **メールアドレス**: `user@example.com` (mailto: リンク)

#### リンクの表示

**ユーザーメッセージ内:**
- 青色の下線付きテキスト
- ホバーで URL プレビュー

**AI メッセージ内:**
- 通常のリンクスタイル (青色、下線)
- 外部リンクには「↗」アイコンが表示

#### リンクのセキュリティ

すべてのリンクは安全に開かれます:
```html
<a href="..." target="_blank" rel="noopener noreferrer">
  リンクテキスト
</a>
```

- **target="_blank"**: 新しいタブで開く
- **rel="noopener noreferrer"**: セキュリティ対策

## フォントカスタマイズ

チャット画面のフォントは、個人の好みに合わせてカスタマイズできます。

### フォントサイズ

**設定可能範囲:** 12px - 20px

**推奨値:**
- **小**: 12px - 快適な情報密度、小さい画面向け
- **標準**: 14px - デフォルト、バランスが良い
- **中**: 16px - 読みやすさ重視
- **大**: 18px - 大きな画面、視認性重視
- **特大**: 20px - アクセシビリティ重視

**設定方法:**
1. 設定画面を開く
2. 「表示」セクションに移動
3. 「フォントサイズ」スライダーを調整
4. リアルタイムでプレビュー表示
5. 変更は自動保存

**スクリーンショットの説明:**
設定画面に、12から20までの数字が表示されたスライダーがあり、現在の値 (例: 14px) が右側に大きく表示されます。下部にプレビューテキストが表示されます。

### フォントファミリー

**利用可能なフォント:**

#### 1. Sans-serif (サンセリフ)
```css
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
             "Helvetica Neue", Arial, sans-serif;
```

**特徴:**
- モダンで読みやすい
- UI に適している
- デフォルト設定

**推奨用途:**
- 一般的なチャット
- 長時間の作業
- モバイルデバイス

#### 2. Monospace (等幅)
```css
font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono",
             "Courier New", monospace;
```

**特徴:**
- コーディングに最適
- 文字の幅が均一
- コードの可読性が高い

**推奨用途:**
- プログラミング作業
- ログの確認
- データ分析

**設定方法:**
1. 設定画面を開く
2. 「表示」セクションに移動
3. 「フォントファミリー」ドロップダウンから選択
4. 即座に適用

### カスタムフォントの適用

システムにインストールされている任意のフォントを使用できます:

```css
/* カスタムフォントの例 */
font-family: "Fira Code", "JetBrains Mono", "Source Code Pro", monospace;
```

**設定:**
1. 設定画面の「カスタムフォント」欄に入力
2. 複数のフォントをカンマ区切りで指定可能
3. フォールバックフォントを最後に指定

## 高度な機能

### ファイルアップロード

チャットにファイルを添付して、AI に分析させることができます。

#### サポートされるファイル形式

- **テキスト**: `.txt`, `.md`, `.log`
- **コード**: `.py`, `.js`, `.go`, `.rs`, `.java`, `.c`, `.cpp`
- **設定**: `.yaml`, `.json`, `.toml`, `.xml`
- **画像**: `.png`, `.jpg`, `.gif`, `.svg`
- **ドキュメント**: `.pdf`, `.docx` (テキスト抽出)

#### アップロード方法

**方法 1: ドラッグ&ドロップ**
1. ファイルをチャット画面にドラッグ
2. ドロップゾーンが表示される
3. ファイルをドロップ

**方法 2: ファイル選択**
1. 入力エリア左側のクリップアイコンをクリック
2. ファイル選択ダイアログが開く
3. ファイルを選択

**複数ファイル:**
- 最大 10 ファイルまで同時アップロード可能
- 各ファイルの最大サイズ: 10MB

**スクリーンショットの説明:**
ファイルをドラッグすると、チャット画面全体が薄い青色のオーバーレイで覆われ、中央に「ファイルをドロップしてアップロード」というテキストとアイコンが表示されます。

#### ファイルプレビュー

アップロード前にファイルをプレビューできます:

```
┌─────────────────────────────────────┐
│ 📄 config.yaml (1.2 KB)       [×]  │
│ 🐍 main.py (3.4 KB)           [×]  │
│ 🖼 screenshot.png (245 KB)    [×]  │
└─────────────────────────────────────┘
[メッセージを入力...]        [送信]
```

- ファイル名、サイズ、アイコンが表示
- [×] をクリックで削除

### 画像の表示

AI が生成した画像や、アップロードされた画像はインラインで表示されます。

#### 画像の操作

- **クリック**: フルサイズで表示
- **ダウンロード**: 右クリック → 「名前を付けて保存」
- **拡大**: Lightbox で拡大表示

**スクリーンショットの説明:**
画像をクリックすると、画面全体を覆う黒い背景に画像が中央に大きく表示されます。右上に「×」ボタン、画像の下にダウンロードボタンがあります。

### メッセージのアクション

各メッセージには、便利なアクションメニューがあります。

#### 利用可能なアクション

**ユーザーメッセージ:**
- **編集** (最後のメッセージのみ): メッセージを編集して再送信
- **コピー**: メッセージをクリップボードにコピー
- **削除**: メッセージを削除

**AI メッセージ:**
- **コピー**: メッセージをクリップボードにコピー
- **再生成**: AI に再度応答を生成させる
- **フィードバック**: 👍 👎 で応答の品質を評価

**アクセス方法:**
メッセージにホバーすると、右上に「...」メニューが表示されます。

### 会話のエクスポート

チャット履歴を様々な形式でエクスポートできます。

#### エクスポート形式

1. **Markdown** (`.md`)
   ```markdown
   # セッション: feature-dev-session

   ## ユーザー (12:34)
   新しい認証機能を実装してください。

   ## AI (12:35)
   承知しました。認証機能を実装します...
   ```

2. **JSON** (`.json`)
   ```json
   {
     "session_id": "session-123",
     "messages": [
       {
         "role": "user",
         "content": "新しい認証機能を実装してください。",
         "timestamp": "2024-01-27T12:34:00Z"
       }
     ]
   }
   ```

3. **PDF** (`.pdf`)
   - フォーマット済みの PDF ドキュメント
   - コードブロックのシンタックスハイライト付き

**エクスポート方法:**
1. 画面右上の「...」メニューをクリック
2. 「エクスポート」を選択
3. 形式を選択
4. ダウンロード

## アクセシビリティ

チャットインターフェースは、すべてのユーザーが快適に使用できるよう設計されています。

### スクリーンリーダー対応

- すべてのメッセージに適切な `aria-label` を設定
- 送信ボタンに明確な説明 (`aria-label="メッセージを送信"`)
- フォーカス可能な要素の論理的な順序

```html
<div role="log" aria-live="polite" aria-label="チャット履歴">
  <div role="article" aria-label="ユーザーメッセージ、12:34">
    新しい機能を追加してください
  </div>
</div>
```

### キーボードナビゲーション

- **Tab**: 次の要素へ移動
- **Shift+Tab**: 前の要素へ移動
- **Enter**: ボタンをクリック
- **Space**: チェックボックスをトグル

### 色のコントラスト

WCAG 2.1 AA 基準を満たすコントラスト比:
- 通常テキスト: 4.5:1 以上
- 大きなテキスト: 3:1 以上

### フォーカスインジケーター

フォーカスされている要素は、青い枠線で明確に表示されます。

```css
:focus {
  outline: 2px solid #3b82f6;
  outline-offset: 2px;
}
```

## パフォーマンス最適化

### 仮想スクロール

長い会話履歴でもスムーズにスクロールできるよう、仮想スクロールを実装しています。

**仕組み:**
- 画面に表示されているメッセージのみレンダリング
- スクロール時に動的にメッセージをロード
- 数千件のメッセージでもスムーズ

### 画像の遅延読み込み

画像は画面に表示されるまで読み込まれません。

```html
<img loading="lazy" src="..." alt="..." />
```

### メモリ管理

- 古いメッセージは必要に応じてメモリから解放
- 画像キャッシュの最適化
- ストリーミングデータの効率的な処理

## トラブルシューティング

### メッセージが送信できない

**症状:**
送信ボタンをクリックしても反応がない

**原因と対処:**

1. **ネットワーク接続の問題**
   - ネットワーク接続を確認
   - ブラウザのコンソールでエラーを確認

2. **セッションが停止している**
   - セッションのステータスを確認
   - セッションを再起動

3. **認証トークンの期限切れ**
   - ページをリロード
   - 再ログイン

### ストリーミングが途切れる

**症状:**
AI の応答が途中で止まる

**原因と対処:**

1. **ネットワークの不安定**
   - 安定したネットワークに接続
   - 「続きを生成」ボタンで再開

2. **タイムアウト**
   - セッションのタイムアウト設定を確認

3. **レート制限**
   - しばらく待ってから再試行

### フォント設定が反映されない

**症状:**
フォントサイズやファミリーを変更しても反映されない

**原因と対処:**

1. **ブラウザキャッシュ**
   - ページをリロード (Cmd+Shift+R / Ctrl+Shift+R)
   - ブラウザのキャッシュをクリア

2. **カスタムフォントが見つからない**
   - システムにフォントがインストールされているか確認
   - フォールバックフォントが正しく指定されているか確認

## ベストプラクティス

### 1. 明確な指示を送る

AI により良い応答を得るために、明確で具体的な指示を送りましょう。

**良い例:**
```
Python で認証機能を実装してください。
- JWT トークンを使用
- ユーザー登録、ログイン、ログアウトのエンドポイント
- パスワードは bcrypt でハッシュ化
```

**悪い例:**
```
認証を追加して
```

### 2. コンテキストを提供する

AI が作業しやすいよう、必要なコンテキストを提供します。

```
このプロジェクトは Next.js で構築されています。
`src/auth/` ディレクトリに認証関連のコードがあります。
既存の `User` モデルを使用してください。
```

### 3. ファイルアップロードを活用

長いコードやログは、直接貼り付けるよりファイルとしてアップロードしましょう。

- 可読性が向上
- フォーマットが保持される
- 大きなファイルも扱える

### 4. フィードバックを提供

AI の応答に対してフィードバック (👍 👎) を提供することで、応答品質の向上に貢献できます。

### 5. エクスポートで記録を残す

重要な会話は定期的にエクスポートして、記録を残しましょう。

## まとめ

チャットインターフェースは、AI エージェントとの対話の中心です。適切に活用することで、開発作業を大幅に効率化できます。

### 次のステップ

- [セッション管理](./sessions.md) - セッションの作成と管理
- [設定管理](./settings.md) - フォントやテーマのカスタマイズ
- [MCP サーバー](./mcp-servers.md) - AI の機能を拡張

### 関連リソース

- [フロントエンド機能](../frontend/features.md)
- [キーボードショートカット一覧](./settings.md#キーボードショートカット)
- [アクセシビリティガイド](../frontend/features.md#アクセシビリティ)
